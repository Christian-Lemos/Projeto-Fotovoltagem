extends layouts/layoutBase

block tituloPagina
    | Configurações

block content
    h1 Configurações de dispositivo
    .container-fluid
        if(modoDebug == true)
            .row
                .col-sm-12.col-md-12
                    hr
                    h3 Código/ID    
                    p #{dispositivo.codigo}
        .row
            
            .col-sm-12.col-md-12
                hr
                h3 Nome  
                p#nome-dispositivo !{dispositivo.nome}
                form(method = "POST" action = "comandos/sonoff/alterarNome", onsubmit="return false").auto-margin.form-inline#form-alterar-nome
                    input(type="hidden", name = "codigo", value = "#{dispositivo.codigo}")
                    .form-group
                        label(for="nome", style = "text-align:left") Alterar Nome: 
                        input(type="text", placeholder="Digite aqui o novo nome", name = "nome" required).form-control 
                    button(type="submit").btn.btn-primary Alterar
        .row
            .col-sm-12.col-md-12
                hr    
                h3 Tópicos   
                table.table.table-bordered#tabela-topicos
                    thead
                        tr
                            th Nome
                            th Remover
                    tbody
                form(onsubmit="return false").auto-margin.form-inline#form-adicionar-topico
                    input(type="hidden", name = "codigo", value = "#{dispositivo.codigo}")
                    .form-group
                        label(for="topico", style = "text-align:left") Adicionar Tópico: 
                        input(type="text", placeholder="Digite aqui o tópico", name = "topico" required).form-control 
                    button(type="submit").btn.btn-primary Adicionar
                    ul.list-unstyled(style='line-height: 2')
                        li
                            span.fa.fa-exclamation.text-success
                            |  Separe subtópicos por " / ". Por exemplo "casa/quintal" e "casa/quarto";
                        li
                            span.fa.fa-exclamation.text-danger
                            |  Não utilize espaços em branco;
                        li
                            span.fa.fa-exclamation.text-danger  
                            |  NÃO use caractéres especiais 
                            small (*, #, +, etc) com exceção de " / ";
                    
block posScripts
    script.
       
        var codigo = "#{dispositivo.codigo}";
        $("#form-alterar-nome").on('submit', function()
        {
            var info = $(this).serialize();
            var nome = $('input[name="nome"]', $(this)).val(); 

            $.ajax({
                url : '/comandos/sonoff/alterarNome',
                method : 'POST',
                data : info,
                dataType : 'JSON',
                success : function(resposta)
                {
                    GerarNotificacao(resposta.mensagem.conteudo, resposta.mensagem.tipo);
                    if(resposta.mensagem.tipo == "success")
                    {
                        var mensagem = {codigo : codigo, nome : nome};
                        socket.emit('att nome sonoff', JSON.stringify(mensagem));
                        $("#nome-dispositivo").html(nome);    
                    }
                              
                },
                error : function (a)
                {
                    GerarNotificacao("Houve um erro na aplicação. Tente novamente mais tarde.", "danger");
                }
                
            });
        });
        $("#form-adicionar-topico").on('submit', function()
        {
            var info = $(this).serialize();
            var nome = $('input[name="topico"]', $(this)).val(); 
            $.ajax({
                url : '/comandos/sonoff/inscreverTopico',
                method : 'POST',
                data : info,
                dataType : 'JSON',
                success : function(resposta)
                {
                    GerarNotificacao(resposta.mensagem.conteudo, resposta.mensagem.tipo);
                    if(resposta.mensagem.tipo == "success")
                    {
                        var mensagem = {codigo : codigo, topico : nome};
                        socket.emit('sonoff add topico', JSON.stringify(mensagem));
                        AdicionarTopicoTabela(nome.toString().toLowerCase());
                    }
                        
                },
                error : function ()
                {
                    GerarNotificacao("Houve um erro na aplicação. Tente novamente mais tarde.", "danger");
                }
                
            });
        });
        $("#tabela-topicos").on('click', '.btn-remover-topico', function()
        {
            var topico = $(this).data('topico');

            $.ajax({
                url : '/comandos/sonoff/removerTopico',
                method : 'POST',
                data : {codigo : codigo, topico : topico},
                dataType : 'JSON',
                success : function(resposta)
                {
                    var topicolower = topico.toString().toLowerCase();
                    if(resposta.mensagem.tipo == "success")
                    {
                        var mensagem = {codigo : codigo, topico : topico};
                        socket.emit('sonoff rem topico', JSON.stringify(mensagem));
                        RemoverTopicoTabela(topico);
                    }
                   GerarNotificacao(resposta.mensagem.conteudo, resposta.mensagem.tipo);
                },
                error : function ()
                {
                    GerarNotificacao("Houve um erro na aplicação. Tente novamente mais tarde.", "danger");
                }

            });
        });
        function GetTopicos()
        {
           $.ajax({
                url : '/comandos/sonoff/gettopicos',
                method : 'GET',
                data : {codigo : codigo},
                dataType : 'JSON',
                success : function(resposta)
                {
                    var total = Object.keys(resposta.topicos).length;
                    var htmlString = "";
                    for(var i = 0; i < total; i++)  
                        AdicionarTopicoTabela(resposta.topicos[i]);
                },
                error : function ()
                {
                    GerarNotificacao("Houve um erro na aplicação. Tente novamente mais tarde.", "danger");
                }
                
            });
        }

        function AdicionarTopicoTabela(topico)
        {
            var htmlString = "<tr><td>"+topico+"</td><td><button class = 'btn btn-danger btn-remover-topico' data-topico = '"+topico+"'><i class = 'fa fa-times-circle'</i></button></td></tr>"
            console.log($("#tabela-topicos tbody").html());
            $("#tabela-topicos tbody").append(htmlString);
        }

        function RemoverTopicoTabela(topico)
        {
            var topicolower = topico.toLowerCase();
            $("#tabela-topicos .btn-remover-topico").each(function()
            {
                if($(this).data('topico') == topicolower)
                    $(this).parent().parent().remove();
            });
        }

        socket.on('att nome sonoff', function(msg){
            var obj = JSON.parse(msg);
            $("#nome-dispositivo").html(obj.nome);
        });

        socket.on(codigo + ' add topico', function(msg){
            var obj = JSON.parse(msg);
            AdicionarTopicoTabela(obj.topico)
        });

        socket.on(codigo + ' rem topico', function(msg){
            var obj = JSON.parse(msg);
            RemoverTopicoTabela(obj.topico)
        });


        GetTopicos();